---
phase: 02-backend-foundation-rag
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/main.py
  - backend/config.py
  - backend/requirements.txt
  - backend/.env.example
  - backend/rag/__init__.py
  - backend/models/__init__.py
  - backend/models/schemas.py
autonomous: true

must_haves:
  truths:
    - "Backend server starts without errors on uvicorn"
    - "GET /health returns 200 OK response"
    - "Backend directory follows research-recommended structure"
    - "All dependencies install successfully"
  artifacts:
    - path: "backend/main.py"
      provides: "FastAPI application entry point"
      contains: "FastAPI"
    - path: "backend/config.py"
      provides: "Pydantic settings configuration"
      contains: "BaseSettings"
    - path: "backend/requirements.txt"
      provides: "Python dependencies"
      min_lines: 10
    - path: "backend/models/schemas.py"
      provides: "Pydantic models for API"
      contains: "BaseModel"
  key_links:
    - from: "backend/main.py"
      to: "backend/config.py"
      via: "settings import"
      pattern: "from config import"
---

<objective>
Create the FastAPI backend directory structure with all necessary boilerplate, configuration, and dependencies for the RAG system.

Purpose: Establish the backend foundation that the RAG pipeline and API endpoints will build upon.
Output: Working FastAPI server that starts and responds to health checks, with all directories ready for RAG components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-foundation-rag/02-CONTEXT.md
@.planning/phases/02-backend-foundation-rag/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend directory structure and dependencies</name>
  <files>
    backend/requirements.txt
    backend/.env.example
    backend/rag/__init__.py
    backend/models/__init__.py
    backend/scripts/.gitkeep
    backend/knowledge/.gitkeep
  </files>
  <action>
Create the backend directory structure following the research-recommended layout:

```
backend/
├── main.py                 # (Task 2)
├── config.py               # (Task 2)
├── requirements.txt        # This task
├── .env.example            # This task
├── rag/
│   └── __init__.py         # Empty, marks as package
├── models/
│   └── __init__.py         # Empty, marks as package
├── scripts/
│   └── .gitkeep            # Placeholder for ingest.py
└── knowledge/
    └── .gitkeep            # Placeholder for markdown files
```

Create requirements.txt with ALL dependencies from research (exact versions):
```
fastapi==0.128.0
uvicorn[standard]==0.40.0
langchain-chroma>=0.1.2
chromadb==1.4.1
langchain-huggingface
sentence-transformers==5.2.0
langchain-text-splitters==1.1.0
langchain-community==0.4.1
rank_bm25
nltk
pydantic-settings==2.12.0
python-dotenv
pytest
pytest-asyncio
httpx
```

Create .env.example:
```
# Backend Configuration
HOST=0.0.0.0
PORT=8000
DEBUG=true

# RAG Configuration
EMBEDDING_MODEL=sentence-transformers/all-mpnet-base-v2
CHROMA_PERSIST_DIR=./chroma_db
COLLECTION_NAME=berlin_city_knowledge

# Retrieval Settings
RETRIEVAL_K=10
BM25_WEIGHT=0.2
SEMANTIC_WEIGHT=0.8
```
  </action>
  <verify>
    - `ls -la backend/` shows all expected directories and files
    - `ls backend/rag/__init__.py` exists
    - `ls backend/models/__init__.py` exists
    - `cat backend/requirements.txt | wc -l` shows 14+ lines
  </verify>
  <done>Backend directory structure exists with requirements.txt and .env.example containing all research-specified dependencies and configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI application and configuration</name>
  <files>
    backend/main.py
    backend/config.py
    backend/models/schemas.py
  </files>
  <action>
Create backend/config.py with Pydantic settings:
```python
from pydantic_settings import BaseSettings
from functools import lru_cache

class Settings(BaseSettings):
    # Server
    host: str = "0.0.0.0"
    port: int = 8000
    debug: bool = True

    # RAG
    embedding_model: str = "sentence-transformers/all-mpnet-base-v2"
    chroma_persist_dir: str = "./chroma_db"
    collection_name: str = "berlin_city_knowledge"

    # Retrieval
    retrieval_k: int = 10
    bm25_weight: float = 0.2
    semantic_weight: float = 0.8

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

@lru_cache
def get_settings() -> Settings:
    return Settings()
```

Create backend/models/schemas.py with Pydantic models:
```python
from pydantic import BaseModel
from typing import Optional

class RetrievalResult(BaseModel):
    """Single retrieval result from RAG system."""
    content: str
    source: str
    score: float
    type: str  # "contact", "event", or "general"

class RetrievalResponse(BaseModel):
    """Response from /api/chat endpoint (Phase 2 - raw retrieval)."""
    query: str
    results: list[RetrievalResult]
    message: Optional[str] = None  # For empty results fallback

class ChatRequest(BaseModel):
    """Request body for /api/chat endpoint."""
    message: str

class HealthResponse(BaseModel):
    """Response from /health endpoint."""
    status: str
    version: str
```

Create backend/main.py with FastAPI app:
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from config import get_settings
from models.schemas import HealthResponse

settings = get_settings()

app = FastAPI(
    title="Berlin City Chatbot API",
    description="RAG-powered chatbot for Berlin city information",
    version="0.1.0"
)

# CORS middleware for frontend integration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Frontend dev server
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health", response_model=HealthResponse)
async def health_check():
    """Health check endpoint."""
    return HealthResponse(status="healthy", version="0.1.0")

# Placeholder for /api/chat - will be implemented in Plan 02-03
# @app.post("/api/chat", response_model=RetrievalResponse)
# async def chat(request: ChatRequest):
#     pass

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host=settings.host, port=settings.port)
```
  </action>
  <verify>
    - `cd backend && python -c "from config import get_settings; print(get_settings().embedding_model)"` prints the model name
    - `cd backend && python -c "from models.schemas import RetrievalResult; print(RetrievalResult.__fields__.keys())"` shows fields
    - `cd backend && python -c "from main import app; print(app.title)"` prints "Berlin City Chatbot API"
  </verify>
  <done>FastAPI application created with config, schemas, health endpoint, and CORS configured for localhost:3000</done>
</task>

<task type="auto">
  <name>Task 3: Verify backend server starts and responds</name>
  <files>None (verification only)</files>
  <action>
1. Create a Python virtual environment in backend/ if not exists
2. Install dependencies from requirements.txt
3. Start the server with uvicorn
4. Test the health endpoint
5. Stop the server

Commands:
```bash
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

Then in a separate step, start server and test:
```bash
cd backend
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000 &
sleep 3
curl http://localhost:8000/health
# Should return: {"status":"healthy","version":"0.1.0"}
kill %1  # Stop background server
```

Note: If running in CI/non-interactive, use timeout or background process management.
  </action>
  <verify>
    - `curl http://localhost:8000/health` returns `{"status":"healthy","version":"0.1.0"}`
    - Server starts without import errors or warnings
    - Dependencies install without errors
  </verify>
  <done>Backend server starts successfully and health endpoint returns 200 OK with expected response</done>
</task>

</tasks>

<verification>
- [ ] backend/ directory exists with correct structure
- [ ] requirements.txt contains all research-specified dependencies
- [ ] config.py loads settings from environment
- [ ] schemas.py defines RetrievalResult, RetrievalResponse, ChatRequest, HealthResponse
- [ ] main.py creates FastAPI app with CORS and health endpoint
- [ ] Server starts with `uvicorn main:app`
- [ ] GET /health returns 200 with healthy status
</verification>

<success_criteria>
1. Backend directory structure matches research recommendations
2. All Python dependencies install without errors
3. FastAPI server starts and responds to health checks
4. Configuration loads from environment variables
5. CORS configured for frontend at localhost:3000
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-foundation-rag/02-01-SUMMARY.md`
</output>
