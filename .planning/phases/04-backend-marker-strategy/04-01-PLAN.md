---
phase: 04-backend-marker-strategy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/models/schemas.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "/api/chat accepts marker query param"
    - "Invalid marker values return 400 Bad Request"
    - "Default marker (no param) uses xml"
    - "Response includes X-Marker-Strategy header"
  artifacts:
    - path: "backend/models/schemas.py"
      provides: "MarkerStrategy enum"
      contains: "class MarkerStrategy"
    - path: "backend/main.py"
      provides: "marker query param handling"
      contains: "marker:"
  key_links:
    - from: "backend/main.py"
      to: "backend/models/schemas.py"
      via: "MarkerStrategy import"
      pattern: "from models.schemas import.*MarkerStrategy"
---

<objective>
Add marker query parameter support to /api/chat endpoint with validation

Purpose: Enable frontend renderers to request their preferred output format (xml for Streamdown, llm-ui for llm-ui renderer)
Output: Working endpoint that accepts marker param, validates it, and includes strategy header in response
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-backend-marker-strategy/04-CONTEXT.md
@.planning/phases/04-backend-marker-strategy/04-RESEARCH.md

# Key source files
@backend/models/schemas.py
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MarkerStrategy enum to schemas</name>
  <files>backend/models/schemas.py</files>
  <action>
Add MarkerStrategy enum at top of file (after imports, before other classes):

```python
from enum import Enum

class MarkerStrategy(str, Enum):
    """Output format strategy for entity markers."""
    XML = "xml"
    LLM_UI = "llm-ui"
```

Use `str, Enum` inheritance so FastAPI auto-documents valid values and pydantic serializes cleanly.
  </action>
  <verify>Import succeeds: `python -c "from models.schemas import MarkerStrategy; print(MarkerStrategy.XML.value)"`</verify>
  <done>MarkerStrategy enum exists with XML and LLM_UI values</done>
</task>

<task type="auto">
  <name>Task 2: Update /api/chat to accept marker query param</name>
  <files>backend/main.py</files>
  <action>
1. Import MarkerStrategy in main.py:
   `from models.schemas import ..., MarkerStrategy`

2. Add logging at module level for marker tracking:
   Already have `logger = logging.getLogger(__name__)`

3. Update chat_stream function signature to accept marker query param with default:
   ```python
   @app.post("/api/chat")
   async def chat_stream(
       request: AgentChatRequest,
       marker: str = "xml"
   ):
   ```

4. Add validation at start of function:
   ```python
   # Validate marker parameter
   valid_markers = [m.value for m in MarkerStrategy]
   if marker not in valid_markers:
       raise HTTPException(
           status_code=400,
           detail={"error": "Invalid marker", "valid_values": valid_markers}
       )

   logger.info(f"Chat request with marker={marker}")
   ```

5. Update StreamingResponse to include X-Marker-Strategy header:
   ```python
   return StreamingResponse(
       stream_agent_response(lc_messages, message_id),
       media_type="text/event-stream",
       headers={**SSE_HEADERS, "X-Marker-Strategy": marker},
   )
   ```

Note: Don't pass marker to stream_agent_response yet - that's Plan 02's job. This plan just adds the API surface.
  </action>
  <verify>
Test with curl:
- `curl -X POST "http://localhost:8000/api/chat?marker=xml" -H "Content-Type: application/json" -d '{"messages":[{"role":"user","content":"hi"}]}' -v 2>&1 | grep X-Marker-Strategy` shows xml
- `curl -X POST "http://localhost:8000/api/chat?marker=llm-ui" ...` shows llm-ui
- `curl -X POST "http://localhost:8000/api/chat?marker=invalid" ...` returns 400
- `curl -X POST "http://localhost:8000/api/chat" ...` (no param) uses xml default
  </verify>
  <done>
- marker query param accepted on /api/chat
- Invalid values return 400 with valid_values hint
- Default is xml when param omitted
- X-Marker-Strategy header included in response
- Marker choice logged at INFO level
  </done>
</task>

</tasks>

<verification>
1. Backend starts without errors: `cd backend && python -c "from main import app; print('OK')"`
2. Health check still works: `curl http://localhost:8000/health`
3. Marker param validation works as specified
4. Response headers include X-Marker-Strategy
5. Server logs show marker choice at INFO level
</verification>

<success_criteria>
- /api/chat?marker=xml returns 200 with X-Marker-Strategy: xml
- /api/chat?marker=llm-ui returns 200 with X-Marker-Strategy: llm-ui
- /api/chat (no marker) defaults to xml
- /api/chat?marker=foo returns 400 with valid_values array
- Requirements MARK-01 partially satisfied (param acceptance - prompt adaptation is Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-backend-marker-strategy/04-01-SUMMARY.md`
</output>
