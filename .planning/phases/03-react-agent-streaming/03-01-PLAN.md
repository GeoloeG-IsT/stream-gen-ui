---
phase: 03-react-agent-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/agent/__init__.py
  - backend/agent/state.py
  - backend/agent/tools.py
  - backend/agent/prompts.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Agent state TypedDict exists with messages annotation"
    - "RAG tool wraps existing retriever with proper descriptions"
    - "System prompt instructs entity marker format"
  artifacts:
    - path: "backend/agent/state.py"
      provides: "AgentState TypedDict with add_messages annotation"
      exports: ["AgentState"]
    - path: "backend/agent/tools.py"
      provides: "RAG knowledge base tool with timeout and error handling"
      exports: ["search_knowledge_base"]
    - path: "backend/agent/prompts.py"
      provides: "System prompt with entity formatting instructions"
      exports: ["AGENT_SYSTEM_PROMPT", "get_agent_prompt"]
    - path: "backend/agent/__init__.py"
      provides: "Module exports"
      exports: ["AgentState", "search_knowledge_base", "AGENT_SYSTEM_PROMPT"]
  key_links:
    - from: "backend/agent/tools.py"
      to: "backend/rag/retriever.py"
      via: "imports get_hybrid_retriever"
      pattern: "from rag.retriever import"
---

<objective>
Create the foundational components for the ReAct agent: state definition, RAG tool, and system prompts.

Purpose: Establish the building blocks that the LangGraph state machine will use. The RAG tool wraps the existing retriever with proper tool descriptions so the agent knows when to invoke it. The system prompt instructs the agent on entity marker formatting.

Output: `backend/agent/` module with state.py, tools.py, prompts.py
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-react-agent-streaming/03-CONTEXT.md
@.planning/phases/03-react-agent-streaming/03-RESEARCH.md
@.planning/phases/02-backend-foundation-rag/02-03-SUMMARY.md
@backend/rag/retriever.py
@backend/config.py
@frontend/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent dependencies to requirements.txt</name>
  <files>backend/requirements.txt</files>
  <action>
Add the following dependencies to requirements.txt:

```
langgraph>=0.2.0
langchain-mistralai>=0.2.0
sse-starlette>=2.0.0
tenacity>=8.0.0
langsmith>=0.1.0
```

These are from the research standard stack. LangGraph for the agent graph, langchain-mistralai for Mistral LLM with tool calling, sse-starlette for SSE utilities, tenacity for retry logic, langsmith for observability.
  </action>
  <verify>
Run `pip install -r backend/requirements.txt` from backend/ directory. All packages install without errors.
  </verify>
  <done>
New dependencies are in requirements.txt and installed in the virtual environment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agent state definition</name>
  <files>backend/agent/state.py, backend/agent/__init__.py</files>
  <action>
Create `backend/agent/__init__.py` as empty initially (will add exports after other files).

Create `backend/agent/state.py` with the AgentState TypedDict:

```python
from typing import Annotated, Sequence, TypedDict
from langchain_core.messages import BaseMessage
from langgraph.graph.message import add_messages

class AgentState(TypedDict):
    """State for the ReAct agent graph.

    Uses add_messages annotation to properly accumulate messages
    across graph iterations (Thought -> Action -> Observation cycles).
    """
    messages: Annotated[Sequence[BaseMessage], add_messages]
```

The `add_messages` annotation is critical - it tells LangGraph how to merge message updates instead of replacing the entire list.
  </action>
  <verify>
From backend/ directory:
```python
python -c "from agent.state import AgentState; print(AgentState.__annotations__)"
```
Should show messages field with Annotated type.
  </verify>
  <done>
AgentState TypedDict is importable and has the correct messages annotation with add_messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RAG tool with timeout and error handling</name>
  <files>backend/agent/tools.py</files>
  <action>
Create `backend/agent/tools.py` with the RAG knowledge base tool:

```python
import asyncio
from functools import wraps
import logging
from langchain.tools import tool
from rag.retriever import get_hybrid_retriever, retrieve_with_scores, deduplicate_results

logger = logging.getLogger(__name__)

# Timeout decorator for tool execution (30 seconds per user requirement)
TOOL_TIMEOUT_SECONDS = 30

def async_tool_timeout(seconds: int):
    """Decorator to timeout async tool execution."""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            try:
                return await asyncio.wait_for(
                    func(*args, **kwargs),
                    timeout=seconds
                )
            except asyncio.TimeoutError:
                logger.warning(f"Tool {func.__name__} timed out after {seconds}s")
                return f"The operation timed out after {seconds} seconds. Please try a simpler query."
        return wrapper
    return decorator


@tool
async def search_knowledge_base(query: str) -> str:
    """Search the Berlin city knowledge base for contacts, events, and information.

    **Use this tool when the user asks about:**
    - Specific people's contact details (email, phone, address)
    - Department or agency contact information
    - Upcoming events, festivals, or city calendar
    - City services, facilities, or general information

    **DO NOT use this tool for:**
    - General greetings or small talk
    - Questions about your capabilities
    - Math calculations or reasoning tasks
    - Information not related to Berlin city services

    Args:
        query: The search query describing what information to find

    Returns:
        Relevant information from the knowledge base with source attribution
    """
    try:
        retriever = get_hybrid_retriever()
        if retriever is None:
            return "The knowledge base is not currently available. Please try again later."

        # Retrieve with scores and deduplicate
        raw_results = retrieve_with_scores(query, k=10)
        unique_results = deduplicate_results(raw_results)

        if not unique_results:
            return "I didn't find any information matching that query. Try asking about contacts, events, or city services."

        # Format results with source attribution
        formatted_results = []
        for doc, score in unique_results[:5]:  # Top 5 results
            source = doc.metadata.get("attribution", "Unknown source")
            doc_type = doc.metadata.get("type", "general")
            formatted_results.append(
                f"[Source: {source} | Type: {doc_type} | Relevance: {score:.2f}]\n{doc.page_content}"
            )

        return "\n\n---\n\n".join(formatted_results)

    except Exception as e:
        logger.error(f"RAG retrieval failed: {e}", exc_info=True)
        return "I couldn't access the knowledge base right now. Please try again in a moment."


# Apply timeout wrapper for async execution
search_knowledge_base_with_timeout = async_tool_timeout(TOOL_TIMEOUT_SECONDS)(
    search_knowledge_base.coroutine
)
```

Key points:
- Tool description is detailed with when to use / when NOT to use (from research pitfalls)
- 30-second timeout per user requirement
- Error handling returns user-friendly messages, logs details server-side
- Returns top 5 results with source attribution
  </action>
  <verify>
From backend/ directory:
```python
python -c "from agent.tools import search_knowledge_base; print(search_knowledge_base.name, search_knowledge_base.description[:50])"
```
Should print tool name and start of description.
  </verify>
  <done>
RAG tool is importable, has detailed description, and includes timeout + error handling.
  </done>
</task>

</tasks>

<verification>
From backend/ directory, verify all agent components:

```bash
cd backend && source venv/bin/activate
python -c "
from agent.state import AgentState
from agent.tools import search_knowledge_base
print('State:', AgentState.__annotations__.keys())
print('Tool:', search_knowledge_base.name)
"
```

All imports succeed, showing state has 'messages' key and tool has correct name.
</verification>

<success_criteria>
- backend/agent/ module exists with __init__.py, state.py, tools.py
- AgentState TypedDict has messages field with add_messages annotation
- search_knowledge_base tool has detailed description and 30s timeout
- Tool wraps existing RAG retriever from backend/rag/
- All new dependencies installed without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-react-agent-streaming/03-01-SUMMARY.md`
</output>
